<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layouts/base}">
<head>
    <title layout:fragment="title">채팅방</title>
</head>

<body>
<div layout:fragment="content">
    <div id="chatRoot"
         th:attr="data-room-id=${roomId}, data-user-id=${userId}"
         class="mx-auto max-w-5xl px-6 py-10">

        <div class="mb-5 flex items-center justify-between">
            <div class="flex items-center gap-3">
                <div class="h-10 w-10 rounded-2xl bg-slate-900 text-white flex items-center justify-center font-black">
                    C
                </div>
                <div>
                    <div class="text-lg font-extrabold text-gray-900 leading-tight">채팅</div>
                    <div class="text-xs text-gray-500">거래 관련 대화를 나눠요</div>
                </div>
            </div>

            <a href="/chats"
               class="inline-flex items-center gap-2 rounded-xl border border-gray-200 bg-white px-3 py-2 text-sm text-gray-700 hover:bg-gray-50">
                목록으로
                <span class="text-gray-400">›</span>
            </a>
        </div>

        <section class="rounded-3xl border border-gray-200 bg-white shadow-sm overflow-hidden">
            <div class="flex items-center justify-between px-5 py-4 border-b border-gray-100 bg-gradient-to-b from-white to-gray-50">
                <button id="loadMore"
                        class="inline-flex items-center gap-2 rounded-xl border border-gray-200 bg-white px-3 py-2 text-sm text-gray-700 hover:bg-gray-50">
                    이전 메시지
                </button>

                <div class="text-xs text-gray-500">
                    실시간 채팅
                </div>
            </div>

            <div class="relative">
                <div class="pointer-events-none absolute inset-x-0 top-0 h-10 bg-gradient-to-b from-white to-transparent"></div>
                <div class="pointer-events-none absolute inset-x-0 bottom-0 h-16 bg-gradient-to-t from-white to-transparent"></div>

                <div id="messages"
                     class="h-[62vh] overflow-y-auto bg-white px-5 py-6 space-y-3">
                    <div class="text-sm text-gray-500">불러오는 중...</div>
                </div>
            </div>

            <div class="border-t border-gray-100 bg-white px-5 py-4">
                <div class="flex items-end gap-3">
                    <div class="flex-1">
                        <div class="rounded-2xl border border-gray-200 bg-gray-50 px-4 py-3 focus-within:ring-2 focus-within:ring-gray-200">
                            <textarea id="messageInput"
                                      rows="1"
                                      class="w-full resize-none bg-transparent text-sm outline-none placeholder:text-gray-400"
                                      placeholder="메시지를 입력하세요..."></textarea>
                        </div>
                        <div class="mt-1 text-[11px] text-gray-400">Enter 전송 · Shift+Enter 줄바꿈</div>
                    </div>

                    <button id="sendBtn"
                            class="h-11 shrink-0 rounded-2xl bg-slate-900 px-5 text-sm font-semibold text-white hover:bg-slate-800 active:scale-[0.99]">
                        전송
                    </button>
                </div>
            </div>
        </section>
    </div>
</div>

<th:block layout:fragment="scripts">
    <script>
        (() => {
            const root = document.getElementById('chatRoot');
            if (!root) return;

            const roomId = root.dataset.roomId;
            const myUserId = root.dataset.userId;

            const messagesEl = document.getElementById('messages');
            const loadMoreBtn = document.getElementById('loadMore');
            const inputEl = document.getElementById('messageInput');
            const sendBtn = document.getElementById('sendBtn');

            let cursor = null;
            let loading = false;
            let stompClient = null;

            // ✅ 한글 IME(조합) 이슈 방지용
            let composing = false;

            // ✅ 아주 짧은 시간 중복 전송 방지 (더블 이벤트/모바일 등)
            let lastSendAt = 0;

            function getAccessToken() {
                return localStorage.getItem('accessToken') || sessionStorage.getItem('accessToken');
            }

            function escapeHtml(str) {
                return String(str ?? '')
                    .replaceAll('&', '&amp;')
                    .replaceAll('<', '&lt;')
                    .replaceAll('>', '&gt;')
                    .replaceAll('"', '&quot;')
                    .replaceAll("'", '&#39;');
            }

            function normalizeMessage(m) {
                return {
                    id: m.messageId ?? m.chatMessageId ?? m.id ?? null,
                    roomId: m.roomId ?? m.chatRoomId ?? null,
                    senderId: String(m.senderId ?? m.sender ?? m.userId ?? ''),
                    content: String(m.content ?? m.message ?? ''),
                    at: m.createdAt ?? m.sentAt ?? m.at ?? null
                };
            }

            function formatTime(v) {
                if (!v) return '';
                const d = new Date(v);
                if (Number.isNaN(d.getTime())) return '';
                return d.toLocaleTimeString('ko-KR', { hour: '2-digit', minute: '2-digit' });
            }

            function isNearBottom(el, threshold = 120) {
                return el.scrollHeight - (el.scrollTop + el.clientHeight) <= threshold;
            }

            function setLoadMore(enabled, label) {
                loadMoreBtn.disabled = !enabled;
                loadMoreBtn.classList.toggle('opacity-50', !enabled);
                loadMoreBtn.classList.toggle('cursor-not-allowed', !enabled);
                if (label) loadMoreBtn.textContent = label;
            }

            function renderMessage(raw) {
                const m = normalizeMessage(raw);
                const mine = m.senderId === String(myUserId);
                const content = escapeHtml(m.content);
                const time = formatTime(m.at);

                const bubbleClass = mine
                    ? 'bg-slate-900 text-white rounded-2xl rounded-br-md'
                    : 'bg-white text-gray-900 border border-gray-200 rounded-2xl rounded-bl-md';

                return `
          <div class="flex ${mine ? 'justify-end' : 'justify-start'}">
            <div class="max-w-[74%]">
              <div class="${bubbleClass} px-4 py-2.5 text-sm shadow-sm whitespace-pre-wrap break-words">
                ${content}
              </div>
              ${time ? `<div class="mt-1 text-[11px] text-gray-400 ${mine ? 'text-right' : 'text-left'}">${time}</div>` : ``}
            </div>
          </div>
        `;
            }

            async function loadMessages(nextCursor) {
                if (loading) return;
                loading = true;

                setLoadMore(false, '불러오는 중...');
                if (!nextCursor) {
                    messagesEl.innerHTML = `<div class="text-sm text-gray-500">불러오는 중...</div>`;
                }

                try {
                    const url = new URL(`/api/chat/rooms/${roomId}/messages`, location.origin);
                    if (nextCursor) url.searchParams.set('cursor', nextCursor);

                    const token = getAccessToken();
                    const headers = token ? { Authorization: `Bearer ${token}` } : {};

                    const res = await fetch(url, { method: 'GET', headers, credentials: 'same-origin' });

                    if (!res.ok) {
                        const txt = await res.text().catch(() => '');
                        messagesEl.innerHTML = `
              <div class="rounded-2xl border border-red-200 bg-red-50 p-4">
                <div class="text-sm font-semibold text-red-700">메시지 조회 실패 (${res.status})</div>
                <div class="mt-2 text-xs whitespace-pre-wrap text-red-700/90">${escapeHtml(txt)}</div>
              </div>
            `;
                        setLoadMore(false, '이전 메시지');
                        return;
                    }

                    const list = await res.json();
                    if (!Array.isArray(list) || list.length === 0) {
                        if (!nextCursor) {
                            messagesEl.innerHTML = `<div class="text-sm text-gray-500">메시지가 아직 없어요.</div>`;
                        }
                        setLoadMore(false, '이전 메시지 없음');
                        return;
                    }

                    // 서버가 DESC(최신→과거)로 준다고 가정 → 화면은 ASC로
                    const asc = [...list].reverse();
                    const html = asc.map(renderMessage).join('');

                    if (!nextCursor) {
                        messagesEl.innerHTML = html;
                        messagesEl.scrollTop = messagesEl.scrollHeight;
                    } else {
                        const prevHeight = messagesEl.scrollHeight;
                        messagesEl.insertAdjacentHTML('afterbegin', html);
                        messagesEl.scrollTop = messagesEl.scrollHeight - prevHeight;
                    }

                    // 다음 커서: 이번 응답에서 "가장 과거" 메시지 id
                    const last = normalizeMessage(list[list.length - 1]);
                    cursor = last.id;

                    setLoadMore(Boolean(cursor), '이전 메시지');
                } finally {
                    loading = false;
                }
            }

            function connectStomp() {
                // 혹시 모를 중복 연결 정리
                try { stompClient?.disconnect?.(() => {}); } catch (_) {}

                const sock = new SockJS('/ws');
                stompClient = Stomp.over(sock);
                stompClient.debug = null;

                // 필요하면 헤더에 토큰 넣기 (서버 설정에 따라)
                // const token = getAccessToken();
                // const headers = token ? { Authorization: `Bearer ${token}` } : {};
                const headers = {};

                stompClient.connect(headers, () => {
                    stompClient.subscribe(`/topic/chat.rooms.${roomId}`, (frame) => {
                        const msg = JSON.parse(frame.body);

                        const shouldStick = isNearBottom(messagesEl);
                        messagesEl.insertAdjacentHTML('beforeend', renderMessage(msg));
                        if (shouldStick) messagesEl.scrollTop = messagesEl.scrollHeight;
                    });
                }, () => {});
            }

            function sendMessage() {
                const now = Date.now();
                if (now - lastSendAt < 150) return;
                lastSendAt = now;

                const content = (inputEl.value || '').trim();
                if (!content) return;

                if (!stompClient || !stompClient.connected) return;

                const payload = {
                    roomId: Number(roomId),
                    senderId: myUserId,
                    content
                };

                stompClient.send('/app/chat.send', {}, JSON.stringify(payload));
                inputEl.value = '';
                autosize();
                inputEl.focus();
            }

            function autosize() {
                inputEl.style.height = 'auto';
                inputEl.style.height = Math.min(inputEl.scrollHeight, 160) + 'px';
            }

            // 이벤트
            loadMoreBtn.addEventListener('click', () => {
                if (!cursor) return;
                loadMessages(cursor);
            });

            sendBtn.addEventListener('click', sendMessage);

            // ✅ IME 조합 상태 추적
            inputEl.addEventListener('compositionstart', () => { composing = true; });
            inputEl.addEventListener('compositionend', () => { composing = false; });

            // ✅ “안녕하세요요” 같은 현상 방지 포인트
            inputEl.addEventListener('keydown', (e) => {
                if (e.key !== 'Enter') return;
                if (e.shiftKey) return; // 줄바꿈
                // 조합 중 Enter는 "조합 확정"일 수 있어서 전송하면 글자 중복/깨짐 발생
                if (e.isComposing || composing || e.keyCode === 229) return;

                e.preventDefault();
                sendMessage();
            });

            inputEl.addEventListener('input', autosize);

            // 페이지 이탈 시 연결 정리(뒤로가기 캐시/재진입 중복 subscribe 방지)
            window.addEventListener('beforeunload', () => {
                try { stompClient?.disconnect?.(() => {}); } catch (_) {}
            });

            setLoadMore(false, '불러오는 중...');
            loadMessages(null);
            connectStomp();
            autosize();
        })();
    </script>
</th:block>

</body>
</html>
