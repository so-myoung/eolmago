<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security"
      layout:decorate="~{layouts/base}">
<head>
    <title layout:fragment="title">경매 등록</title>
</head>

<body>
<section layout:fragment="content"
         id="draftPage"
         class="mx-auto max-w-7xl px-6 py-10"
         th:attr="
           data-api-base=|${apiBase ?: '/api/auctions'}|,
           data-auction-id=|${auctionId ?: ''}|,
           data-mode=|${mode ?: 'create'}|,
           data-redirect-after-publish=|${redirectAfterPublish ?: '/seller/auctions'}|,
           data-redirect-after-delete=|${redirectAfterDelete ?: '/seller/auctions'}|,
           data-edit-view-base='/seller/auctions/drafts',
           data-supabase-url=|${supabaseUrl}|,
           data-supabase-anon-key=|${supabaseAnonKey}|,
           data-supabase-bucket='eolmago',
           data-supabase-base-path='auction_items'
         ">

    <!-- Header -->
    <div class="mb-8">
        <div class="flex flex-wrap items-end justify-between gap-4">
            <div>
                <div class="text-xs text-gray-500">
                    <a th:href="@{/}" class="hover:text-gray-900">홈</a>
                    <span class="px-1">/</span>
                    <a th:href="@{/seller/auctions}" class="hover:text-gray-900">판매 관리</a>
                    <span class="px-1">/</span>
                    <span class="text-gray-900 font-medium"
                          th:text="'경매 등록'">경매 등록</span>
                </div>

                <h1 class="mt-2 text-3xl font-bold tracking-tight text-gray-900">
                    새 경매 등록
                </h1>

                <p class="mt-2 text-sm text-gray-600">
                    임시 저장 후 언제든지 이어서 작성할 수 있습니다. 게시 시점에 경매가 시작됩니다.
                </p>
            </div>

            <!-- Status badge -->
            <div class="flex items-center gap-2">
                <span id="statusBadge"
                      class="inline-flex items-center rounded-full border px-3 py-1 text-xs font-semibold
                             border-gray-200 bg-white text-gray-800">
                  상태: <span class="ml-1" id="statusText" th:text="${statusText} ?: '작성 중'">작성 중</span>
                </span>

                <span id="savedAtBadge"
                      class="hidden lg:inline-flex items-center rounded-full border border-gray-200 bg-white px-3 py-1 text-xs text-gray-600">
                  마지막 저장: <span class="ml-1" id="savedAtText">-</span>
                </span>
            </div>
        </div>
    </div>

    <!-- Alert -->
    <div id="formAlert" class="mb-6 hidden rounded-2xl border border-red-200 bg-red-50 px-5 py-4 text-sm text-red-800"></div>

    <div class="grid grid-cols-1 gap-8 lg:grid-cols-12">
        <!-- Main -->
        <div class="lg:col-span-8 space-y-6">

            <!-- Product info -->
            <div id="sec-product" class="rounded-2xl border border-gray-200 bg-white p-7 shadow-sm">
                <div class="flex items-start justify-between gap-4">
                    <div>
                        <h2 class="text-lg font-bold text-gray-900">상품 정보</h2>
                        <p class="mt-1 text-sm text-gray-600">검색과 노출에 중요한 정보입니다. 정확하게 입력해주세요.</p>
                    </div>
                    <span class="inline-flex items-center rounded-full bg-gray-50 px-3 py-1 text-xs font-semibold text-gray-700">
                        필수 항목 포함
                    </span>
                </div>

                <div class="mt-6 grid grid-cols-1 gap-6">
                    <!-- Item name -->
                    <div>
                        <label for="itemName" class="block text-sm font-semibold text-gray-900">상품명 <span class="text-red-600">*</span></label>
                        <p class="mt-1 text-xs text-gray-500">모델명/세부 옵션을 포함하면 구매자 신뢰도가 올라갑니다.</p>
                        <input id="itemName" type="text" maxlength="100"
                               class="mt-3 w-full rounded-xl border border-gray-300 bg-white px-4 py-3 text-sm outline-none transition
                                      focus:border-gray-900 focus:ring-4 focus:ring-gray-900/10"
                               placeholder="예: iPhone 14 Pro 256GB 딥퍼플"
                               data-required />
                        <p class="mt-2 text-xs text-red-700 hidden" data-error="itemName"></p>
                    </div>

                    <!-- Category + Condition -->
                    <div class="grid grid-cols-1 gap-6 md:grid-cols-2">
                        <div>
                            <label for="category" class="block text-sm font-semibold text-gray-900">카테고리 <span class="text-red-600">*</span></label>
                            <p class="mt-1 text-xs text-gray-500">카테고리에 따라 필수 스펙 입력이 활성화됩니다.</p>

                            <select id="category"
                                    class="mt-3 w-full rounded-xl border border-gray-300 bg-white px-4 py-3 text-sm outline-none transition
                                           focus:border-gray-900 focus:ring-4 focus:ring-gray-900/10"
                                    data-required>
                                <option value="" selected disabled>선택해주세요</option>

                                <!-- ✅ label(한글명) 출력 -->
                                <option th:each="c : ${T(kr.eolmago.domain.entity.auction.enums.ItemCategory).values()}"
                                        th:value="${c.name()}"
                                        th:text="${c.label}">
                                    PHONE
                                </option>
                            </select>

                            <p class="mt-2 text-xs text-red-700 hidden" data-error="category"></p>
                        </div>

                        <div>
                            <label for="condition" class="block text-sm font-semibold text-gray-900">상품 상태 <span class="text-red-600">*</span></label>
                            <p class="mt-1 text-xs text-gray-500">상태를 솔직하게 선택하면 분쟁 가능성이 낮아집니다.</p>

                            <select id="condition"
                                    class="mt-3 w-full rounded-xl border border-gray-300 bg-white px-4 py-3 text-sm outline-none transition
                                           focus:border-gray-900 focus:ring-4 focus:ring-gray-900/10"
                                    data-required>
                                <option value="" selected disabled>선택해주세요</option>
                                <option th:each="c : ${T(kr.eolmago.domain.entity.auction.enums.ItemCondition).values()}"
                                        th:value="${c}" th:text="${c}">LIKE_NEW</option>
                            </select>

                            <p class="mt-2 text-xs text-red-700 hidden" data-error="condition"></p>
                        </div>
                    </div>

                    <!-- Auction title -->
                    <div>
                        <label for="title" class="block text-sm font-semibold text-gray-900">경매 제목 <span class="text-red-600">*</span></label>
                        <p class="mt-1 text-xs text-gray-500">구매자가 목록에서 바로 보는 문구입니다. 100자 이내를 권장합니다.</p>

                        <div class="mt-3">
                            <input id="title" type="text" maxlength="100"
                                   class="w-full rounded-xl border border-gray-300 bg-white px-4 py-3 text-sm outline-none transition
                                          focus:border-gray-900 focus:ring-4 focus:ring-gray-900/10"
                                   placeholder="예: 풀박 iPhone 14 Pro 256GB, 배터리 90%, 생활 스크래치 1곳"
                                   data-required data-count-target="titleCount" />
                            <div class="mt-2 flex items-center justify-between text-xs">
                                <span class="text-gray-500">100자 이내</span>
                                <span class="text-gray-600"><span id="titleCount" class="font-semibold text-gray-900">0</span>/100</span>
                            </div>
                            <p class="mt-2 text-xs text-red-700 hidden" data-error="title"></p>
                        </div>
                    </div>

                    <!-- Description -->
                    <div>
                        <label for="description" class="block text-sm font-semibold text-gray-900">
                            상세 설명
                        </label>
                        <p class="mt-1 text-xs text-gray-500">구매 시기, 사용감, 하자 여부, 구성품, 거래 방식 등을 구체적으로 작성해주세요.</p>

                        <textarea id="description" maxlength="2000"
                                  class="mt-3 min-h-[180px] w-full rounded-xl border border-gray-300 bg-white px-4 py-3 text-sm outline-none transition
                                         focus:border-gray-900 focus:ring-4 focus:ring-gray-900/10 resize-none"
                                  placeholder="- 구매 시기: 2023년 3월&#10;- 사용 기간: 6개월&#10;- 상태: 액정/후면 스크래치 없음 (테두리 미세 스크래치 1곳)&#10;- 구성품: 박스, 정품 케이블, 충전기"
                                  data-count-target="descCount"></textarea>

                        <div class="mt-2 flex items-center justify-between text-xs">
                            <span class="text-gray-500">2,000자 이내</span>
                            <span class="text-gray-600"><span id="descCount" class="font-semibold text-gray-900">0</span>/2000</span>
                        </div>
                    </div>

                    <!-- ✅ Required specs (brand + storageGb) -->
                    <div id="requiredSpecsBox" class="rounded-2xl border border-gray-200 bg-white p-5">
                        <div class="flex items-start justify-between gap-4">
                            <div>
                                <h3 class="text-sm font-bold text-gray-900">필수 스펙 <span class="text-red-600">*</span></h3>
                            </div>
                        </div>

                        <div class="mt-4 grid grid-cols-1 gap-6 md:grid-cols-2">
                            <!-- Brand -->
                            <div>
                                <label for="brandSelect" class="block text-sm font-semibold text-gray-900">브랜드 <span class="text-red-600">*</span></label>
                                <!-- 용량과 줄 맞추기 위해 한 줄 확보 -->
                                <p class="mt-1 text-xs text-gray-500">&nbsp;</p>

                                <select id="brandSelect"
                                        class="mt-3 w-full rounded-xl border border-gray-300 bg-white px-4 py-3 text-sm outline-none transition
                                               focus:border-gray-900 focus:ring-4 focus:ring-gray-900/10"
                                        disabled>
                                    <option value="" selected disabled>선택해주세요</option>
                                    <option value="Apple">Apple</option>
                                    <option value="Samsung">Samsung</option>
                                    <option value="__custom__">직접 입력</option>
                                </select>

                                <div id="brandCustomWrap" class="mt-3 hidden">
                                    <input id="brandCustomInput" type="text" maxlength="30"
                                           class="w-full rounded-xl border border-gray-300 bg-white px-4 py-3 text-sm outline-none transition
                                                  focus:border-gray-900 focus:ring-4 focus:ring-gray-900/10"
                                           placeholder="예: LG" />
                                    <p class="mt-1 text-xs text-gray-500">직접 입력은 오탈자에 주의해주세요.</p>
                                </div>

                                <p class="mt-2 text-xs text-red-700 hidden" data-error="brand"></p>
                            </div>

                            <!-- Storage -->
                            <div>
                                <label for="storageGb" class="block text-sm font-semibold text-gray-900">용량(GB) <span class="text-red-600">*</span></label>
                                <p class="mt-1 text-xs text-gray-500">숫자만 입력 가능합니다. (예: 64)</p>

                                <div class="mt-3 relative">
                                    <input id="storageGb" type="text" inputmode="numeric"
                                           class="w-full rounded-xl border border-gray-300 bg-white px-4 py-3 pr-12 text-sm outline-none transition
                                                  focus:border-gray-900 focus:ring-4 focus:ring-gray-900/10"
                                           placeholder="예: 64"
                                           disabled />
                                    <span class="absolute right-4 top-1/2 -translate-y-1/2 text-xs font-semibold text-gray-500">GB</span>
                                </div>

                                <p class="mt-2 text-xs text-red-700 hidden" data-error="storageGb"></p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Auction settings -->
            <div id="sec-auction" class="rounded-2xl border border-gray-200 bg-white p-7 shadow-sm">
                <div class="flex items-start justify-between gap-4">
                    <div>
                        <h2 class="text-lg font-bold text-gray-900">경매 설정</h2>
                    </div>
                </div>

                <div class="mt-6 grid grid-cols-1 gap-6 md:grid-cols-2">
                    <!-- Start price -->
                    <div>
                        <label for="startPrice" class="block text-sm font-semibold text-gray-900">시작가 <span class="text-red-600">*</span></label>
                        <p class="mt-1 text-xs text-gray-500">10,000원 ~ 10,000,000원</p>

                        <div class="mt-3 relative">
                            <span class="absolute left-4 top-1/2 -translate-y-1/2 text-gray-500 text-sm font-semibold">₩</span>
                            <input id="startPrice" type="text" inputmode="numeric"
                                   class="w-full rounded-xl border border-gray-300 bg-white py-3 pl-10 pr-4 text-sm outline-none transition
                                          focus:border-gray-900 focus:ring-4 focus:ring-gray-900/10"
                                   placeholder="예: 100,000"
                                   data-required />
                        </div>
                        <p class="mt-2 text-xs text-red-700 hidden" data-error="startPrice"></p>
                    </div>

                    <!-- Duration -->
                    <div>
                        <label for="durationHours" class="block text-sm font-semibold text-gray-900">경매 기간 <span class="text-red-600">*</span></label>
                        <p class="mt-1 text-xs text-gray-500">최소 12시간, 최대 7일(168시간)</p>

                        <select id="durationHours"
                                class="mt-3 w-full rounded-xl border border-gray-300 bg-white px-4 py-3 text-sm outline-none transition
                                       focus:border-gray-900 focus:ring-4 focus:ring-gray-900/10"
                                data-required>
                            <option value="" disabled>선택해주세요</option>
                            <option value="12">12시간</option>
                            <option value="24">24시간 (1일)</option>
                            <option value="48">48시간 (2일)</option>
                            <option value="72">72시간 (3일)</option>
                            <option value="96">96시간 (4일)</option>
                            <option value="120">120시간 (5일)</option>
                            <option value="144">144시간 (6일)</option>
                            <option value="168">168시간 (7일)</option>
                        </select>
                        <p class="mt-2 text-xs text-red-700 hidden" data-error="durationHours"></p>
                    </div>

                    <!-- End preview -->
                    <div class="md:col-span-2">
                        <label class="block text-sm font-semibold text-gray-900">종료 예정 시각</label>
                        <p class="mt-1 text-xs text-gray-500">게시 시점 기준으로 자동 계산됩니다</p>

                        <div class="mt-3 rounded-xl border border-gray-200 bg-gray-50 px-4 py-3">
                            <div class="text-sm font-semibold text-gray-900" id="endAtPreview">기간을 선택하면 표시됩니다</div>
                            <div class="mt-1 text-xs text-gray-600" id="endAtHint">게시 시점부터 기간만큼 더한 시각</div>
                        </div>
                    </div>
                </div>

                <!-- Auto extension notice -->
                <div class="mt-6 rounded-2xl border border-gray-200 bg-white">
                    <div class="flex items-start gap-3 px-5 py-4">
                        <div class="mt-0.5 inline-flex h-9 w-9 flex-shrink-0 items-center justify-center rounded-xl bg-slate-900 text-white">
                            <svg class="h-5 w-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M12 8v4l3 3"></path>
                                <path d="M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z"></path>
                            </svg>
                        </div>
                        <div class="flex-1">
                            <h3 class="text-sm font-bold text-gray-900">자동 연장 규칙</h3>
                            <p class="mt-1 text-sm text-gray-700 leading-relaxed">
                                종료 <span class="font-semibold text-gray-900">5분 전</span> 입찰이 발생하면, 종료 시간이
                                <span class="font-semibold text-gray-900">5분 자동 연장</span>됩니다.
                            </p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Images -->
            <div id="sec-images" class="rounded-2xl border border-gray-200 bg-white p-7 shadow-sm">
                <div class="flex items-start justify-between gap-4">
                    <div>
                        <h2 class="text-lg font-bold text-gray-900">상품 이미지</h2>
                        <p class="mt-1 text-sm text-gray-600">최소 1장, 최대 10장. 드래그로 순서를 변경할 수 있습니다.</p>
                    </div>
                    <div class="text-xs text-gray-600">
                        <span id="imageCount" class="font-semibold text-gray-900">0</span>/10
                    </div>
                </div>

                <div class="mt-6">
                    <!-- Upload row -->
                    <div class="flex flex-wrap items-center gap-3">
                        <label class="inline-flex cursor-pointer items-center rounded-xl bg-slate-900 px-4 py-2.5 text-sm font-semibold text-white hover:bg-slate-800">
                            <input id="imageInput" type="file" accept="image/*" multiple class="hidden" />
                            이미지 선택
                        </label>
                    </div>

                    <!-- Dropzone -->
                    <div id="dropzone"
                         class="mt-4 rounded-2xl border-2 border-dashed border-gray-300 bg-gray-50 px-5 py-6">
                        <div class="flex items-start justify-between gap-4">
                            <div>
                                <h4 class="text-sm font-bold text-gray-900">여기에 파일을 끌어다 놓을 수 있습니다</h4>
                                <p class="mt-1 text-xs text-gray-600">권장: 정면/후면/측면/하자 부위/구성품</p>
                            </div>
                            <div class="text-xs text-gray-500">JPG/PNG/WebP 권장</div>
                        </div>

                        <!-- Thumbs -->
                        <div id="thumbGrid" class="mt-5 grid grid-cols-2 gap-4 sm:grid-cols-3 md:grid-cols-4">
                            <!-- JS render -->
                        </div>
                    </div>

                    <p class="mt-3 text-xs text-red-700 hidden" data-error="imageUrls"></p>
                </div>
            </div>
        </div>

        <!-- Sidebar -->
        <aside class="lg:col-span-4 space-y-6">
            <!-- Summary -->
            <div class="sticky top-24 rounded-2xl border border-gray-200 bg-white p-6 shadow-sm">
                <div class="flex items-center justify-between">
                    <h3 class="text-sm font-bold text-gray-900">요약</h3>
                    <a th:href="@{/seller/auctions}" class="text-xs font-semibold text-gray-600 hover:text-gray-900">목록으로</a>
                </div>

                <div class="mt-4 space-y-3">
                    <div class="rounded-xl bg-gray-50 px-4 py-3">
                        <div class="text-xs text-gray-500">상품명</div>
                        <div class="mt-1 text-sm font-semibold text-gray-900 truncate" id="summaryItemName">-</div>
                    </div>

                    <div class="grid grid-cols-2 gap-3">
                        <div class="rounded-xl bg-gray-50 px-4 py-3">
                            <div class="text-xs text-gray-500">시작가</div>
                            <div class="mt-1 text-sm font-semibold text-gray-900" id="summaryStartPrice">-</div>
                        </div>
                        <div class="rounded-xl bg-gray-50 px-4 py-3">
                            <div class="text-xs text-gray-500">기간</div>
                            <div class="mt-1 text-sm font-semibold text-gray-900" id="summaryDuration">-</div>
                        </div>
                    </div>

                    <div class="rounded-xl bg-gray-50 px-4 py-3">
                        <div class="text-xs text-gray-500">이미지</div>
                        <div class="mt-1 text-sm font-semibold text-gray-900"><span id="summaryImages">0</span>장</div>
                    </div>

                    <div class="rounded-xl border border-gray-200 bg-white px-4 py-3">
                        <div class="text-xs text-gray-500">게시 안내</div>
                        <div class="mt-1 text-sm text-gray-700 leading-relaxed">
                            게시 시점에 경매가 시작됩니다. 게시 이후에는 임시 저장 수정이 제한됩니다.
                        </div>
                    </div>
                </div>

                <div class="mt-5 space-y-3">
                    <button type="button" id="saveDraftBtn"
                            class="w-full rounded-xl bg-slate-900 py-3 text-sm font-bold text-white hover:bg-slate-800"
                            th:attr="disabled=${!#authorization.expression('hasAnyRole(''USER'', ''ADMIN'')') ? 'disabled' : null}">
                        임시 저장
                    </button>

                    <!-- 게시하기: 초기에도 가능(항상 enabled) -->
                    <button type="button" id="publishBtn"
                            class="w-full rounded-xl border border-gray-300 bg-white py-3 text-sm font-bold text-gray-900 hover:bg-gray-100 disabled:opacity-50 disabled:cursor-not-allowed"
                            th:attr="disabled=${!#authorization.expression('hasAnyRole(''USER'', ''ADMIN'')') ? 'disabled' : null}">
                        게시하기
                    </button>

                    <button type="button" id="deleteBtn"
                            class="w-full rounded-xl border border-red-200 bg-white py-3 text-sm font-bold text-red-700 hover:bg-red-50 disabled:opacity-50 disabled:cursor-not-allowed"
                            th:attr="disabled=${!#authorization.expression('hasAnyRole(''USER'', ''ADMIN'')') ? 'disabled' : null}"
                            disabled>
                        삭제
                    </button>

                    <!-- 게시 실패 재시도 UI -->
                    <div id="publishRetryBox"
                         class="hidden rounded-xl border border-red-200 bg-red-50 px-4 py-3 text-sm text-red-800">
                        게시에 실패했습니다. 네트워크/서버 상태를 확인한 뒤 다시 시도해주세요.
                        <div class="mt-2 flex justify-end">
                            <button type="button" id="retryPublishBtn"
                                    class="rounded-lg bg-red-600 px-3 py-2 text-xs font-semibold text-white hover:bg-red-700">
                                다시 시도
                            </button>
                        </div>
                    </div>

                    <p class="text-center text-xs text-gray-500">
                        임시 저장은 언제든 수정할 수 있습니다.
                    </p>
                </div>
            </div>
        </aside>
    </div>

    <!-- Toast -->
    <div id="toast" class="fixed bottom-6 right-6 z-50 hidden w-[320px] rounded-2xl border border-gray-200 bg-white px-4 py-3 shadow-lg">
        <div class="text-sm font-bold text-gray-900" id="toastTitle">알림</div>
        <div class="mt-1 text-sm text-gray-700" id="toastMsg"></div>
    </div>

</section>

<th:block layout:fragment="scripts">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <script th:src="@{/js/seller/create-auction/util.js}" defer></script>
    <script th:src="@{/js/seller/create-auction/api.js}" defer></script>
    <script th:src="@{/js/seller/create-auction/storage.js}" defer></script>
    <script th:src="@{/js/seller/create-auction/ui.js}" defer></script>
    <script th:src="@{/js/seller/create-auction/flow.js}" defer></script>
</th:block>

</body>
</html>
